<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Cloud</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #ef4444;
      --success: #10b981;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      font-size: 14px;
    }

    /* Layout Containers */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header & Breadcrumbs */
    .app-header {
      background: var(--card-bg);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .breadcrumb {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      flex-wrap: wrap;
    }

    .breadcrumb a {
      text-decoration: none;
      color: var(--text-muted);
      transition: color 0.2s;
    }

    .breadcrumb a:hover, .breadcrumb a:last-child {
      color: var(--primary);
    }

    /* Search Bar */
    .search-form {
      position: relative;
      margin-top: 10px;
    }
    
    @media (min-width: 768px) {
      .search-form { margin-top: 0; }
    }

    .search-input {
      padding: 10px 15px 10px 35px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-color);
      width: 100%;
      min-width: 250px;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .btn-search {
      display: none; /* Hidden visually, enter key works */
    }

    /* Toolbar / Actions */
    .toolbar {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 25px;
      background: var(--card-bg);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    @media (min-width: 768px) {
      .toolbar {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }

    .create-form, .bulk-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .input-std {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    /* Buttons */
    button, .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    
    .btn-danger { background: #fee2e2; color: var(--danger); }
    .btn-danger:hover { background: #fecaca; }

    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: var(--bg-color); }

    /* Grid Layout for Files & Folders */
    .section-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin: 20px 0 10px 0;
      font-weight: 600;
    }

    .grid-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }

    /* Card Item Style */
    .item-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      cursor: pointer;
    }

    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border-color: var(--primary);
    }

    .item-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: var(--text-muted);
    }

    .folder .item-icon { color: #f59e0b; } /* Amber for folders */
    .file .item-icon { color: var(--primary); } /* Blue for files */

    .item-name {
      font-weight: 500;
      color: var(--text-main);
      text-decoration: none;
      margin-bottom: 10px;
      word-break: break-word;
      display: block;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* File Actions Overlay */
    .item-actions {
      display: flex;
      gap: 5px;
      margin-top: auto;
      font-size: 0.8rem;
    }

    .item-actions a, .item-actions button {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 4px;
      text-decoration: none;
    }

    .drop-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 5px;
      border-top: 1px dashed var(--border);
      width: 100%;
      padding-top: 5px;
    }

    /* Root Drop Zone */
    .root-drop-zone {
      border: 2px dashed var(--primary);
      background: #eff6ff;
      color: var(--primary);
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    /* Checkbox absolute positioning */
    .file-checkbox {
      position: absolute;
      top: 10px;
      left: 10px;
      transform: scale(1.2);
      cursor: pointer;
    }

    /* Utilities */
    .hidden-mobile { display: none; }
    @media (min-width: 600px) { .hidden-mobile { display: inline; } }

  </style>
</head>

<body>

  <header class="app-header">
    <div class="breadcrumb">
      <i class="fa-brands fa-google-drive" style="color: var(--primary); margin-right: 8px;"></i>
      <a href="/dashboard">My Cloud</a>
      <% breadcrumb.forEach(folder=> { %>
        <span style="color:var(--text-muted); margin: 0 5px;">/</span>
        <a href="/dashboard/<%= folder._id %>">
          <%= folder.name %>
        </a>
      <% }) %>
    </div>

    <form action="/search" method="GET" class="search-form">
      <i class="fas fa-search search-icon"></i>
      <input type="text" name="q" class="search-input" placeholder="Search..." required />
      <button type="submit" class="btn-search">Search</button>
    </form>
  </header>

  <div class="container">

    <div class="toolbar">
      <form action="/folder/create" method="POST" class="create-form">
        <input type="text" name="name" class="input-std" placeholder="New folder name" required />
        <input type="hidden" name="parentFolderId" value="<%= currentFolder ? currentFolder._id : '' %>" />
        <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> <span class="hidden-mobile">New Folder</span></button>
      </form>

      <div class="bulk-actions">
         <select id="bulkFolderSelect" class="input-std">
          <option value="">Move to Root</option>
          <% folders.forEach(folder=> { %>
            <option value="<%= folder._id %>">
              <%= folder.name %>
            </option>
          <% }) %>
        </select>
        <button onclick="bulkMove()" class="btn btn-outline" title="Move Selected"><i class="fas fa-share"></i></button>
        <button onclick="bulkDelete()" class="btn btn-danger" title="Delete Selected"><i class="fas fa-trash"></i></button>
      </div>
    </div>

    <% if (currentFolder) { %>
      <div style="margin-bottom: 15px;">
        <a href="/dashboard/<%= currentFolder.parentFolderId || '' %>" class="btn btn-outline">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>
    <% } %>

    <div class="root-drop-zone" ondragover="allowDrop(event)" ondrop="dropToRoot(event)">
      <i class="fas fa-cloud-arrow-up"></i> Drop files here to move to Root
    </div>

    <div class="section-title">Folders</div>
    
    <% if (folders.length===0) { %>
      <p style="color:var(--text-muted); font-style:italic;">No folders here</p>
    <% } %>

    <div class="grid-view">
      <% folders.forEach(folder=> { %>
        <div class="item-card folder" ondragover="allowDrop(event)" ondrop="dropFile(event)" data-folder-id="<%= folder._id %>">
          
          <a href="/dashboard/<%= folder._id %>" style="display:contents; color:inherit; text-decoration:none;">
            <div class="item-icon"><i class="fas fa-folder"></i></div>
            <div class="item-name" title="<%= folder.name %>"><%= folder.name %></div>
          </a>

          <div class="item-actions">
            <form action="/folder/<%= folder._id %>/delete-hard" method="POST" style="display:inline" onsubmit="return confirm('⚠️ WARNING: This will permanently delete this folder and its contents. Continue?')">
              <button type="submit" class="btn-danger" style="padding:4px 8px; font-size:12px;"><i class="fas fa-trash"></i></button>
            </form>
          </div>
          <div class="drop-hint">Drop files inside</div>
        </div>
      <% }) %>
    </div>

    <hr style="border:0; border-top:1px solid var(--border); margin: 30px 0;">

    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div class="section-title">Files</div>
      <form method="GET" action="/dashboard">
        <select name="type" onchange="this.form.submit()" class="input-std" style="font-size:0.8rem;">
          <option value="">All Types</option>
          <option value="photo">Images</option>
          <option value="video">Videos</option>
          <option value="document">Documents</option>
        </select>
      </form>
    </div>

    <% if (files.length===0) { %>
      <p style="color:var(--text-muted); font-style:italic;">No files here</p>
    <% } %>

    <div class="grid-view">
      <% files.forEach(file=> { %>
        <div class="item-card file" draggable="true" ondragstart="dragFile(event)" data-file-id="<%= file._id %>">
          <input type="checkbox" class="file-checkbox" value="<%= file._id %>" />
          
          <div class="item-icon">
            <% if (file.mimeType === "application/pdf") { %>
              <i class="fas fa-file-pdf" style="color: #ef4444;"></i>
            <% } else if (file.fileType === "photo") { %>
              <i class="fas fa-file-image" style="color: #3b82f6;"></i>
            <% } else if (file.fileType === "video") { %>
              <i class="fas fa-file-video" style="color: #8b5cf6;"></i>
            <% } else { %>
              <i class="fas fa-file-alt"></i>
            <% } %>
          </div>

          <div class="item-name" title="<%= file.fileName %>"><%= file.fileName %></div>

          <div class="item-actions">
            <% if ( file.mimeType==="application/pdf" || file.fileType==="video" || file.fileType==="photo" ) { %>
              <a href="/preview/<%= file._id %>" target="_blank" class="btn-outline" title="Preview"><i class="fas fa-eye"></i></a>
            <% } %>
            
            <a href="/download/<%= file._id %>" class="btn-primary" title="Download"><i class="fas fa-download"></i></a>

            <form action="/file/<%= file._id %>/delete" method="POST" style="display:inline" onsubmit="return confirm('Delete this file permanently?')">
              <button type="submit" class="btn-danger" style="padding: 6px 8px;"><i class="fas fa-trash"></i></button>
            </form>
          </div>
        </div>
      <% }) %>
    </div>

  </div> <script>
    function getSelectedFiles() {
      return Array.from(document.querySelectorAll(".file-checkbox:checked"))
        .map(cb => cb.value);
    }

    async function bulkDelete() {
      const ids = getSelectedFiles();
      if (ids.length === 0) return alert("No files selected");

      if (!confirm("Delete selected files permanently?")) return;

      await fetch("/files/bulk-delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids })
      });

      location.reload();
    }

    async function bulkMove() {
      const ids = getSelectedFiles();
      const folderId = document.getElementById("bulkFolderSelect").value;

      if (ids.length === 0) return alert("No files selected");

      await fetch("/files/bulk-move", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids, folderId })
      });

      location.reload();
    }
  </script>

  <script>
    let draggedFileId = null;

    function dragFile(event) {
      draggedFileId = event.currentTarget.dataset.fileId;
    }

    function allowDrop(event) {
      event.preventDefault();
    }

    async function dropFile(event) {
      event.preventDefault();

      const folderId = event.currentTarget.dataset.folderId;

      if (!draggedFileId || !folderId) return;

      await fetch(`/file/${draggedFileId}/move`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ folderId })
      });

      location.reload();
    }

    async function dropToRoot(event) {
      event.preventDefault();

      if (!draggedFileId) return;

      await fetch(`/file/${draggedFileId}/move`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ folderId: null })
      });

      location.reload();
    }
  </script>

</body>
</html>